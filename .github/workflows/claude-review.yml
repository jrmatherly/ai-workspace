name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

# Only run on @claude mentions in comments, or automatically on PRs
jobs:
  review:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better context

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Use cost-effective model for reviews with safe, read-only tools
          claude_args: "--model claude-sonnet-4-20250514 --allowedTools Read,Glob,Grep,Task --max-turns 20"

          # Custom review prompt
          prompt: |
            Review this PR focusing on:
            1. Code correctness and error handling
            2. Adherence to project patterns (see AGENTS.md)
            3. Test coverage for new code
            4. Security considerations

            For Go code, check:
            - Error wrapping with context
            - Interface design (small, focused)
            - Concurrency patterns
            - Table-driven tests

            For GPTScript tools, check:
            - Required fields (Name, Description, Tools)
            - Credential format
            - Error handling

            Be concise. Only comment on significant issues.
            Format findings by severity: Critical, Warning, Suggestion.

      - name: Post Review Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅' : '❌';
            console.log(`Claude review ${status}`);
