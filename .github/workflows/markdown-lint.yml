name: Markdown Lint

on:
  push:
    branches: [main]
    paths:
      - "**/*.md"
      - ".markdownlint*"
      - ".github/workflows/markdown-lint.yml"
  pull_request:
    paths:
      - "**/*.md"
      - ".markdownlint*"
      - ".github/workflows/markdown-lint.yml"
  workflow_dispatch:
    inputs:
      fix:
        description: "Attempt to auto-fix issues"
        required: false
        default: false
        type: boolean

jobs:
  lint:
    name: Lint Markdown Files
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: |
            **/*.md
            #node_modules
            #**/node_modules/**
            #vendor
            #**/vendor/**
            #.git
            #**/.archive/**
            #**/build/**
          fix: ${{ github.event.inputs.fix || 'false' }}

      - name: Report Results
        if: failure()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const message = `### Markdown Lint Failed

            Some markdown files have linting issues. Please fix them before merging.

            **To check locally:**
            \`\`\`bash
            npx markdownlint-cli2 "**/*.md" "#node_modules"
            \`\`\`

            **To auto-fix (where possible):**
            \`\`\`bash
            npx markdownlint-cli2 --fix "**/*.md" "#node_modules"
            \`\`\`

            See the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            `;

            if (context.eventName === 'pull_request') {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }
