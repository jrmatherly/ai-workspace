#:schema https://mise.jdx.dev/schema/mise.json
# AI/MCP Multi-Repo Workspace Root Configuration
# https://mise.jdx.dev
#
# This is a multi-repo workspace (not a monorepo). Each subdirectory is an
# independent git repository. mise's task discovery works across all repos.
# See: .claude/instructions/multi-repo-workspace-guide.md
#
# Quick Start:
#   curl https://mise.run | sh
#   mise trust
#   mise install
#   mise tasks
#
# Cross-project commands:
#   mise all              - Validate all projects
#   mise test-all         - Test all projects
#   mise //nah:test       - Test specific project
#   mise '//...:test'     - Test all (wildcard)

# =============================================================================
# SETTINGS
# =============================================================================

[settings]
# Enable experimental features for multi-repo task discovery
# Note: mise uses "monorepo" terminology for its task discovery feature,
# but it works equally well for multi-repo workspaces like this one.
experimental = true

[settings.task]
# Reduce search depth for performance (projects are at depth 1-2)
monorepo_depth = 3
# Exclude common directories from task search
monorepo_exclude_dirs = ["node_modules", ".archive", "vendor", "dist", "build", ".venv", ".git"]

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================

[env]
# Go environment
GOPATH = "{{env.HOME}}/go"
GOBIN = "{{env.HOME}}/go/bin"
CGO_ENABLED = "0"

# Mise multi-repo task discovery mode
MISE_EXPERIMENTAL = "1"

# =============================================================================
# SHARED TOOLS
# =============================================================================

[tools]
# Core languages
go = "1.25"
node = "24"
python = "3.14"

# Go tooling (via aqua for version pinning)
"aqua:golangci/golangci-lint" = "2.8.0"

# Git and CI tools
"aqua:cli/cli" = "latest"  # GitHub CLI

# Multi-repo management (see .claude/instructions/multi-repo-workspace-guide.md)
"pipx:gita" = "latest"  # Bulk git operations across child repositories

# =============================================================================
# ROOT-LEVEL TASKS
# =============================================================================

[tasks.help]
description = "Show available workspace tasks"
run = """
echo "AI/MCP Multi-Repo Workspace - mise tasks"
echo ""
echo "Cross-project commands:"
echo "  mise all              - Validate all projects"
echo "  mise test-all         - Test all projects"
echo "  mise tidy-all         - Tidy all Go modules"
echo "  mise status           - Show git status across projects"
echo "  mise deps-check       - Check for outdated dependencies"
echo "  mise clean            - Clean build artifacts"
echo ""
echo "Linting:"
echo "  mise lint-md          - Lint markdown files"
echo "  mise lint-md-fix      - Auto-fix markdown issues"
echo ""
echo "Multi-repo management (gita):"
echo "  mise gita-init        - Register all child repos with gita"
echo "  mise gita-status (gs) - Show git status across all repos"
echo "  mise gita-fetch (gf)  - Fetch all repos"
echo "  mise gita-pull (gp)   - Pull all repos"
echo ""
echo "Project commits (conventional commits):"
echo "  mise commit:obot-entraid (ce)  - Commit obot-entraid changes"
echo "  mise commit:obot-tools (ct)    - Commit obot-tools changes"
echo "  mise commit:nah (cn)           - Commit nah changes"
echo "  mise commit:kinm (ck)          - Commit kinm changes"
echo "  mise commit:mcp-oauth-proxy (cm) - Commit mcp-oauth-proxy changes"
echo "  mise commit:mcp-catalog (cc)   - Commit mcp-catalog changes"
echo ""
echo "  Usage: mise commit:PROJECT -m 'type(scope): message'"
echo "  Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore"
echo ""
echo "Project push:"
echo "  mise push:obot-entraid (pe)    - Push obot-entraid to remote"
echo "  mise push:obot-tools (pt)      - Push obot-tools to remote"
echo "  mise push:nah (pn)             - Push nah to remote"
echo "  mise push:kinm (pk)            - Push kinm to remote"
echo "  mise push:mcp-oauth-proxy (pm) - Push mcp-oauth-proxy to remote"
echo "  mise push:mcp-catalog (pc)     - Push mcp-catalog to remote"
echo "  mise push-all                  - Push all projects (use with caution)"
echo ""
echo "Fork dependency management:"
echo "  mise update-forks (uf)         - Update fork deps to latest (review)"
echo "  mise update-forks-commit (ufc) - Update fork deps and auto-commit"
echo ""
echo "Release management:"
echo "  mise release:kinm VERSION (rk)           - Create kinm release"
echo "  mise release:nah VERSION (rn)            - Create nah release"
echo "  mise release:mcp-oauth-proxy VERSION (rm)- Create mcp-oauth-proxy release"
echo "  mise release:mcp-catalog VERSION (rc)    - Create mcp-catalog release"
echo "  mise release:obot-entraid VERSION (re)   - Create obot-entraid release"
echo "  mise releases                            - Show latest releases"
echo ""
echo "Single project (examples):"
echo "  mise //nah:test       - Test nah only"
echo "  mise //obot-entraid:dev - Run obot-entraid dev server"
echo "  mise :test            - Test current directory project"
echo ""
echo "View all tasks:"
echo "  mise tasks --all"
"""

[tasks.all]
alias = "validate-all"
description = "Run validate-ci on all Go projects"
depends = [
    "//nah:validate-ci",
    "//kinm:validate-ci",
    "//obot-entraid:validate-ci",
    "//mcp-oauth-proxy:validate-ci",
    "//namegenerator:validate"
]

[tasks.test-all]
description = "Run tests on all Go projects"
depends = [
    "//nah:test",
    "//kinm:test",
    "//obot-entraid:test",
    "//mcp-oauth-proxy:test",
    "//namegenerator:test"
]

[tasks.tidy-all]
description = "Run go mod tidy on all projects"
run = """
for dir in obot-entraid nah kinm mcp-oauth-proxy namegenerator; do
    echo "=== Tidying $dir ==="
    cd $dir && go mod tidy && cd ..
done
echo "Done!"
"""

[tasks.status]
description = "Show git status across all projects"
run = """
echo "=== Multi-Repo Workspace Git Status ==="
git status --short
echo ""
for dir in obot-entraid nah kinm mcp-oauth-proxy obot-tools mcp-catalog namegenerator; do
    changes=$(git status --short "$dir" 2>/dev/null | wc -l | tr -d ' ')
    if [ "$changes" -gt 0 ]; then
        echo "$dir: $changes change(s)"
    fi
done
"""

[tasks.deps-check]
description = "Check for outdated Go dependencies"
run = """
echo "Checking for outdated dependencies..."
for dir in obot-entraid nah kinm mcp-oauth-proxy namegenerator; do
    echo "=== $dir ==="
    cd $dir && go list -u -m all 2>/dev/null | grep '\\[' || echo "  All up to date"
    cd ..
done
"""

[tasks.clean]
description = "Clean build artifacts across all projects"
run = """
echo "Cleaning build artifacts..."
find . -name "bin" -type d -not -path "*/node_modules/*" -not -path "*/.archive/*" -exec rm -rf {} + 2>/dev/null || true
find . -name "*.test" -type f -delete 2>/dev/null || true
find . -name "coverage.out" -type f -delete 2>/dev/null || true
find . -name "coverage.html" -type f -delete 2>/dev/null || true
echo "Done!"
"""

# =============================================================================
# LINTING TASKS
# =============================================================================

[tasks.lint-md]
alias = "mdlint"
description = "Lint markdown files across the workspace"
run = 'npx markdownlint-cli2 "**/*.md"'

[tasks.lint-md-fix]
alias = "mdfix"
description = "Auto-fix markdown lint issues where possible"
run = 'npx markdownlint-cli2 --fix "**/*.md"'

# =============================================================================
# MULTI-REPO MANAGEMENT (gita)
# =============================================================================
# See: .claude/instructions/multi-repo-workspace-guide.md

[tasks.gita-init]
description = "Register all child repositories with gita"
run = """
echo "Registering child repositories with gita..."
for dir in obot-entraid nah kinm mcp-oauth-proxy obot-tools mcp-catalog namegenerator; do
    if [ -d "$dir/.git" ]; then
        gita add "$dir" 2>/dev/null || echo "  $dir already registered or failed"
    fi
done
echo ""
echo "Registered repositories:"
MISE_NO_CONFIG=1 gita ll
"""

[tasks.gita-status]
alias = "gs"
description = "Show git status across all registered repos"
run = "MISE_NO_CONFIG=1 gita ll"

[tasks.gita-fetch]
alias = "gf"
description = "Fetch all registered repos"
run = "MISE_NO_CONFIG=1 gita fetch"

[tasks.gita-pull]
alias = "gp"
description = "Pull all registered repos"
run = "MISE_NO_CONFIG=1 gita pull"

[tasks.gita-push]
description = "Push all registered repos (use with caution)"
run = "MISE_NO_CONFIG=1 gita push"

[tasks.gita-cmd]
description = "Run arbitrary git command on all repos (use: mise gita-cmd -- status)"
run = "MISE_NO_CONFIG=1 gita super {{arg(name='cmd')}}"

# =============================================================================
# PROJECT COMMIT TASKS (Conventional Commits)
# =============================================================================
# Format: <type>(<scope>): <description>
#
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
#
# Usage:
#   mise commit:obot-entraid                    # Interactive (opens editor)
#   mise commit:obot-entraid -m "feat: add X"  # With message
#   mise commit:obot-tools -m "fix(auth): Y"   # With scope

[tasks."commit:obot-entraid"]
alias = "ce"
description = "Commit changes in obot-entraid (conventional commits)"
run = """
cd obot-entraid
echo "=== obot-entraid: Staged & Unstaged Changes ==="
git status --short
echo ""
echo "=== Files to be committed ==="
git add -A
git status --short
echo ""

if [ -n "{{option(name='message', short='m', default='')}}" ]; then
    git commit -m "{{option(name='message', short='m')}}

Co-Authored-By: Claude <noreply@anthropic.com>"
else
    echo "Opening editor for commit message..."
    echo "# Conventional Commit Format: <type>(<scope>): <description>"
    echo "# Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore"
    git commit -t /dev/stdin <<'TEMPLATE'
# <type>(<scope>): <short description>
#
# [optional body]
#
# [optional footer]
#
# Co-Authored-By: Claude <noreply@anthropic.com>
# ---
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
# Scope: optional, e.g., auth, ui, api, controller
TEMPLATE
fi
"""

[tasks."commit:obot-tools"]
alias = "ct"
description = "Commit changes in obot-tools (conventional commits)"
run = """
cd obot-tools
echo "=== obot-tools: Staged & Unstaged Changes ==="
git status --short
echo ""
echo "=== Files to be committed ==="
git add -A
git status --short
echo ""

if [ -n "{{option(name='message', short='m', default='')}}" ]; then
    git commit -m "{{option(name='message', short='m')}}

Co-Authored-By: Claude <noreply@anthropic.com>"
else
    git commit -t /dev/stdin <<'TEMPLATE'
# <type>(<scope>): <short description>
#
# [optional body]
#
# [optional footer]
#
# Co-Authored-By: Claude <noreply@anthropic.com>
# ---
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
# Scope: optional, e.g., auth, knowledge, model-provider
TEMPLATE
fi
"""

[tasks."commit:nah"]
alias = "cn"
description = "Commit changes in nah (conventional commits)"
run = """
cd nah
echo "=== nah: Staged & Unstaged Changes ==="
git status --short
echo ""
git add -A

if [ -n "{{option(name='message', short='m', default='')}}" ]; then
    git commit -m "{{option(name='message', short='m')}}

Co-Authored-By: Claude <noreply@anthropic.com>"
else
    git commit -t /dev/stdin <<'TEMPLATE'
# <type>(<scope>): <short description>
#
# [optional body]
#
# Co-Authored-By: Claude <noreply@anthropic.com>
# ---
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
# Scope: optional, e.g., router, backend, apply
TEMPLATE
fi
"""

[tasks."commit:kinm"]
alias = "ck"
description = "Commit changes in kinm (conventional commits)"
run = """
cd kinm
echo "=== kinm: Staged & Unstaged Changes ==="
git status --short
echo ""
git add -A

if [ -n "{{option(name='message', short='m', default='')}}" ]; then
    git commit -m "{{option(name='message', short='m')}}

Co-Authored-By: Claude <noreply@anthropic.com>"
else
    git commit -t /dev/stdin <<'TEMPLATE'
# <type>(<scope>): <short description>
#
# [optional body]
#
# Co-Authored-By: Claude <noreply@anthropic.com>
# ---
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
# Scope: optional, e.g., apiserver, storage, client
TEMPLATE
fi
"""

[tasks."commit:mcp-oauth-proxy"]
alias = "cm"
description = "Commit changes in mcp-oauth-proxy (conventional commits)"
run = """
cd mcp-oauth-proxy
echo "=== mcp-oauth-proxy: Staged & Unstaged Changes ==="
git status --short
echo ""
git add -A

if [ -n "{{option(name='message', short='m', default='')}}" ]; then
    git commit -m "{{option(name='message', short='m')}}

Co-Authored-By: Claude <noreply@anthropic.com>"
else
    git commit -t /dev/stdin <<'TEMPLATE'
# <type>(<scope>): <short description>
#
# [optional body]
#
# Co-Authored-By: Claude <noreply@anthropic.com>
# ---
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
# Scope: optional, e.g., oauth, pkce, token, proxy
TEMPLATE
fi
"""

[tasks."commit:mcp-catalog"]
alias = "cc"
description = "Commit changes in mcp-catalog (conventional commits)"
run = """
cd mcp-catalog
echo "=== mcp-catalog: Staged & Unstaged Changes ==="
git status --short
echo ""
git add -A

if [ -n "{{option(name='message', short='m', default='')}}" ]; then
    git commit -m "{{option(name='message', short='m')}}

Co-Authored-By: Claude <noreply@anthropic.com>"
else
    git commit -t /dev/stdin <<'TEMPLATE'
# <type>(<scope>): <short description>
#
# [optional body]
#
# Co-Authored-By: Claude <noreply@anthropic.com>
# ---
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
# Scope: optional, e.g., servers, registry
TEMPLATE
fi
"""

[tasks."commit:namegenerator"]
alias = "cng"
description = "Commit changes in namegenerator (conventional commits)"
run = """
cd namegenerator
echo "=== namegenerator: Staged & Unstaged Changes ==="
git status --short
echo ""
git add -A

if [ -n "{{option(name='message', short='m', default='')}}" ]; then
    git commit -m "{{option(name='message', short='m')}}

Co-Authored-By: Claude <noreply@anthropic.com>"
else
    git commit -t /dev/stdin <<'TEMPLATE'
# <type>(<scope>): <short description>
#
# [optional body]
#
# Co-Authored-By: Claude <noreply@anthropic.com>
# ---
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
TEMPLATE
fi
"""

# =============================================================================
# PROJECT PUSH TASKS
# =============================================================================
# Push changes to remote for each project
#
# Usage:
#   mise push:obot-entraid           # Push current branch
#   mise push:obot-tools             # Push current branch
#   mise push-all                    # Push all projects (use with caution)

[tasks."push:obot-entraid"]
alias = "pe"
description = "Push obot-entraid changes to remote"
run = """
cd obot-entraid
BRANCH=$(git branch --show-current)
echo "=== obot-entraid: Pushing $BRANCH ==="
git push -u origin "$BRANCH"
echo "✅ Pushed $BRANCH"
"""

[tasks."push:obot-tools"]
alias = "pt"
description = "Push obot-tools changes to remote"
run = """
cd obot-tools
BRANCH=$(git branch --show-current)
echo "=== obot-tools: Pushing $BRANCH ==="
git push -u origin "$BRANCH"
echo "✅ Pushed $BRANCH"
"""

[tasks."push:nah"]
alias = "pn"
description = "Push nah changes to remote"
run = """
cd nah
BRANCH=$(git branch --show-current)
echo "=== nah: Pushing $BRANCH ==="
git push -u origin "$BRANCH"
echo "✅ Pushed $BRANCH"
"""

[tasks."push:kinm"]
alias = "pk"
description = "Push kinm changes to remote"
run = """
cd kinm
BRANCH=$(git branch --show-current)
echo "=== kinm: Pushing $BRANCH ==="
git push -u origin "$BRANCH"
echo "✅ Pushed $BRANCH"
"""

[tasks."push:mcp-oauth-proxy"]
alias = "pm"
description = "Push mcp-oauth-proxy changes to remote"
run = """
cd mcp-oauth-proxy
BRANCH=$(git branch --show-current)
echo "=== mcp-oauth-proxy: Pushing $BRANCH ==="
git push -u origin "$BRANCH"
echo "✅ Pushed $BRANCH"
"""

[tasks."push:mcp-catalog"]
alias = "pc"
description = "Push mcp-catalog changes to remote"
run = """
cd mcp-catalog
BRANCH=$(git branch --show-current)
echo "=== mcp-catalog: Pushing $BRANCH ==="
git push -u origin "$BRANCH"
echo "✅ Pushed $BRANCH"
"""

[tasks."push:namegenerator"]
alias = "png"
description = "Push namegenerator changes to remote"
run = """
cd namegenerator
BRANCH=$(git branch --show-current)
echo "=== namegenerator: Pushing $BRANCH ==="
git push -u origin "$BRANCH"
echo "✅ Pushed $BRANCH"
"""

[tasks.push-all]
description = "Push all projects to remote (use with caution)"
run = """
echo "=== Pushing all projects ==="
echo ""
for dir in obot-entraid obot-tools nah kinm mcp-oauth-proxy mcp-catalog namegenerator; do
    if [ -d "$dir/.git" ]; then
        cd "$dir"
        BRANCH=$(git branch --show-current)
        AHEAD=$(git rev-list --count origin/$BRANCH..$BRANCH 2>/dev/null || echo "0")
        if [ "$AHEAD" -gt 0 ]; then
            echo "Pushing $dir ($BRANCH, $AHEAD commits ahead)..."
            git push -u origin "$BRANCH" || echo "  ⚠️ Push failed for $dir"
        else
            echo "Skipping $dir (nothing to push)"
        fi
        cd ..
    fi
done
echo ""
echo "✅ Done"
"""

# =============================================================================
# FORK DEPENDENCY MANAGEMENT
# =============================================================================
# Tools for managing forked dependencies across projects
#
# The jrmatherly/* forks are used via replace directives in go.mod.
# These tasks help keep them updated without manual version editing.

[tasks.update-forks]
alias = "uf"
description = "Update all jrmatherly fork dependencies in obot-entraid to latest"
run = '''
echo "=== Updating Fork Dependencies ==="
echo ""
cd obot-entraid

echo "Current fork versions:"
grep 'github.com/jrmatherly' go.mod | grep -v '//' || echo "  No forks found"
echo ""

# Get latest tags from GitHub
echo "Fetching latest releases from GitHub..."
KINM_TAG=$(gh release list --repo jrmatherly/kinm --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null)
NAH_TAG=$(gh release list --repo jrmatherly/nah --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null)
PROXY_TAG=$(gh release list --repo jrmatherly/mcp-oauth-proxy --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null)

echo "  kinm: $KINM_TAG"
echo "  nah: $NAH_TAG"
echo "  mcp-oauth-proxy: $PROXY_TAG"
echo ""

# Update replace directives
echo "Updating replace directives..."
[ -n "$KINM_TAG" ] && go mod edit -replace "github.com/obot-platform/kinm=github.com/jrmatherly/kinm@$KINM_TAG"
[ -n "$NAH_TAG" ] && go mod edit -replace "github.com/obot-platform/nah=github.com/jrmatherly/nah@$NAH_TAG"
[ -n "$PROXY_TAG" ] && go mod edit -replace "github.com/obot-platform/mcp-oauth-proxy=github.com/jrmatherly/mcp-oauth-proxy@$PROXY_TAG"

echo ""
echo "Running go mod tidy..."
go mod tidy

echo ""
echo "Updated fork versions:"
grep 'github.com/jrmatherly' go.mod | grep -v '//' || echo "  No forks found"

echo ""
echo "Changes to go.mod:"
git diff --stat go.mod go.sum 2>/dev/null || echo "  No changes"

echo ""
echo "✅ Done! Review changes and commit if satisfied."
'''

[tasks.update-forks-commit]
alias = "ufc"
description = "Update forks and auto-commit changes"
run = '''
echo "=== Updating Fork Dependencies with Auto-Commit ==="
cd obot-entraid

# Get current versions for commit message
OLD_KINM=$(grep 'jrmatherly/kinm' go.mod | awk '{print $NF}')
OLD_NAH=$(grep 'jrmatherly/nah' go.mod | awk '{print $NF}')
OLD_PROXY=$(grep 'jrmatherly/mcp-oauth-proxy' go.mod | awk '{print $NF}')

# Get latest tags from GitHub
NEW_KINM=$(gh release list --repo jrmatherly/kinm --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null)
NEW_NAH=$(gh release list --repo jrmatherly/nah --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null)
NEW_PROXY=$(gh release list --repo jrmatherly/mcp-oauth-proxy --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null)

echo "Current: kinm=$OLD_KINM nah=$OLD_NAH proxy=$OLD_PROXY"
echo "Latest:  kinm=$NEW_KINM nah=$NEW_NAH proxy=$NEW_PROXY"

# Update replace directives
[ -n "$NEW_KINM" ] && go mod edit -replace "github.com/obot-platform/kinm=github.com/jrmatherly/kinm@$NEW_KINM"
[ -n "$NEW_NAH" ] && go mod edit -replace "github.com/obot-platform/nah=github.com/jrmatherly/nah@$NEW_NAH"
[ -n "$NEW_PROXY" ] && go mod edit -replace "github.com/obot-platform/mcp-oauth-proxy=github.com/jrmatherly/mcp-oauth-proxy@$NEW_PROXY"
go mod tidy

# Check if there are changes
if git diff --quiet go.mod go.sum; then
    echo "✅ All forks already at latest versions"
    exit 0
fi

# Build commit message
UPDATES=""
[ "$OLD_KINM" != "$NEW_KINM" ] && UPDATES="${UPDATES}kinm $OLD_KINM->$NEW_KINM, "
[ "$OLD_NAH" != "$NEW_NAH" ] && UPDATES="${UPDATES}nah $OLD_NAH->$NEW_NAH, "
[ "$OLD_PROXY" != "$NEW_PROXY" ] && UPDATES="${UPDATES}mcp-oauth-proxy $OLD_PROXY->$NEW_PROXY, "
UPDATES="${UPDATES%, }"

git add go.mod go.sum
git commit -m "chore(deps): update fork dependencies

Updated: $UPDATES

Co-Authored-By: Claude <noreply@anthropic.com>"

echo ""
echo "✅ Committed fork updates. Push when ready."
'''

# =============================================================================
# RELEASE MANAGEMENT
# =============================================================================
# Streamlined release creation for forked projects
#
# Usage:
#   mise release:kinm 0.1.10           # Create kinm v0.1.10
#   mise release:nah 0.1.3             # Create nah v0.1.3
#   mise release:mcp-oauth-proxy 0.1.4 # Create mcp-oauth-proxy v0.1.4

[tasks."release:kinm"]
alias = "rk"
description = "Create a new release for kinm (usage: mise release:kinm VERSION)"
run = """
VERSION="{{arg(name='version')}}"
if [ -z "$VERSION" ]; then
    echo "Usage: mise release:kinm VERSION"
    echo "Example: mise release:kinm 0.1.10"
    exit 1
fi

cd kinm
echo "=== Creating kinm v$VERSION ==="

# Ensure we're on main and up to date
git checkout main
git pull origin main

# Check for uncommitted changes
if ! git diff --quiet; then
    echo "⚠️  Uncommitted changes detected. Commit or stash first."
    exit 1
fi

# Create the release
gh release create "v$VERSION" --generate-notes --title "v$VERSION"

echo ""
echo "✅ Created kinm v$VERSION"
echo "   View: https://github.com/jrmatherly/kinm/releases/tag/v$VERSION"
"""

[tasks."release:nah"]
alias = "rn"
description = "Create a new release for nah (usage: mise release:nah VERSION)"
run = """
VERSION="{{arg(name='version')}}"
if [ -z "$VERSION" ]; then
    echo "Usage: mise release:nah VERSION"
    echo "Example: mise release:nah 0.1.3"
    exit 1
fi

cd nah
echo "=== Creating nah v$VERSION ==="

git checkout main
git pull origin main

if ! git diff --quiet; then
    echo "⚠️  Uncommitted changes detected. Commit or stash first."
    exit 1
fi

gh release create "v$VERSION" --generate-notes --title "v$VERSION"

echo ""
echo "✅ Created nah v$VERSION"
echo "   View: https://github.com/jrmatherly/nah/releases/tag/v$VERSION"
"""

[tasks."release:mcp-oauth-proxy"]
alias = "rm"
description = "Create a new release for mcp-oauth-proxy (usage: mise release:mcp-oauth-proxy VERSION)"
run = """
VERSION="{{arg(name='version')}}"
if [ -z "$VERSION" ]; then
    echo "Usage: mise release:mcp-oauth-proxy VERSION"
    echo "Example: mise release:mcp-oauth-proxy 0.1.4"
    exit 1
fi

cd mcp-oauth-proxy
echo "=== Creating mcp-oauth-proxy v$VERSION ==="

git checkout main
git pull origin main

if ! git diff --quiet; then
    echo "⚠️  Uncommitted changes detected. Commit or stash first."
    exit 1
fi

gh release create "v$VERSION" --generate-notes --title "v$VERSION"

echo ""
echo "✅ Created mcp-oauth-proxy v$VERSION"
echo "   View: https://github.com/jrmatherly/mcp-oauth-proxy/releases/tag/v$VERSION"
"""

[tasks."release:mcp-catalog"]
alias = "rc"
description = "Create a new release for mcp-catalog (usage: mise release:mcp-catalog VERSION)"
run = """
VERSION="{{arg(name='version')}}"
if [ -z "$VERSION" ]; then
    echo "Usage: mise release:mcp-catalog VERSION"
    echo "Example: mise release:mcp-catalog 0.1.3"
    exit 1
fi

cd mcp-catalog
echo "=== Creating mcp-catalog v$VERSION ==="

git checkout main
git pull origin main

if ! git diff --quiet; then
    echo "⚠️  Uncommitted changes detected. Commit or stash first."
    exit 1
fi

gh release create "v$VERSION" --generate-notes --title "v$VERSION"

echo ""
echo "✅ Created mcp-catalog v$VERSION"
echo "   View: https://github.com/jrmatherly/mcp-catalog/releases/tag/v$VERSION"
"""

[tasks."release:obot-entraid"]
alias = "re"
description = "Create a new release for obot-entraid (usage: mise release:obot-entraid VERSION)"
run = """
VERSION="{{arg(name='version')}}"
if [ -z "$VERSION" ]; then
    echo "Usage: mise release:obot-entraid VERSION"
    echo "Example: mise release:obot-entraid 0.2.39"
    exit 1
fi

cd obot-entraid
echo "=== Creating obot-entraid v$VERSION ==="

git checkout main
git pull origin main

if ! git diff --quiet; then
    echo "⚠️  Uncommitted changes detected. Commit or stash first."
    exit 1
fi

gh release create "v$VERSION" --generate-notes --title "v$VERSION"

echo ""
echo "✅ Created obot-entraid v$VERSION"
echo "   View: https://github.com/jrmatherly/obot-entraid/releases/tag/v$VERSION"
"""

[tasks.releases]
description = "Show latest releases for all forked projects"
run = '''
echo "=== Latest Releases ==="
echo ""

for repo in kinm nah mcp-oauth-proxy mcp-catalog obot-entraid; do
    LATEST=$(gh release list --repo "jrmatherly/$repo" --limit 1 --json tagName,publishedAt --jq '.[0] | "\(.tagName) (\(.publishedAt | split("T")[0]))"' 2>/dev/null || echo "no releases")
    printf "%-20s %s\n" "$repo:" "$LATEST"
done
'''
